#!/bin/bash
__dir=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
source "$__dir"/../useful_commands.sh
. "${__dir}"/../vars/variables.sh

# Use absolute paths for logs
LOGS_DIR=${__dir}/../../testutil/debugging/logs
mkdir -p "$LOGS_DIR"
LOGS_DIR=$(cd "$LOGS_DIR" && pwd)
rm "$LOGS_DIR"/*.log 2>/dev/null || true

# Save project root for later use
PROJECT_ROOT=$(cd "${__dir}/../.." && pwd)

echo "============================================"
echo "Smart Router Direct RPC (Lava Local Node)"
echo "============================================"
echo "Mode: DIRECT RPC (no Lava providers)"
echo "Upstream: Local lavad REST (LCD) + gRPC"
echo "============================================"
echo ""

# Kill all lavap and lavad processes (best-effort)
killall lavap lavad 2>/dev/null || true
sleep 1

# Kill all screen sessions (best-effort)
killall screen 2>/dev/null || true
sleep 1
screen -wipe
sleep 1

echo "[Test Setup] installing all binaries"
make install-all

echo ""
echo "[Test Setup] starting a new local Lava node"
screen -d -m -S node bash -c "cd \"$PROJECT_ROOT\" && ./scripts/start_env_dev.sh"
echo "[Test Setup] waiting for node to start..."
sleep 5
wait_for_lava_node_to_start

# Start cache service (optional but recommended)
echo ""
echo "[Test Setup] starting smart router cache service"
screen -d -m -S cache bash -c "source ~/.bashrc; lavap cache \
127.0.0.1:20100 --metrics_address 0.0.0.0:20200 --log_level debug 2>&1 | tee \"$LOGS_DIR/CACHE.log\"" && sleep 0.25
sleep 2

# Use local loopback addresses (0.0.0.0 is a bind address; as a client target prefer 127.0.0.1)
LAVA_REST_LOCAL="${LAVA_REST/0.0.0.0/127.0.0.1}"
# gRPC URLs need grpc:// prefix for protocol detection (grpcs:// for TLS)
LAVA_GRPC_LOCAL="grpc://${LAVA_GRPC/0.0.0.0/127.0.0.1}"

# Static specs (offline) - used for routing/parsing in smart router.
# IMPORTANT: Lava spec imports COSMOSSDK (and related deps), so we must provide the full bundle.
# Note: chain-id verifications in public specs won't match the local dev chain-id ("lava"),
# so we explicitly skip those verifications in node-urls below.
SPECS_DIR="$PROJECT_ROOT/specs/mainnet-1/specs/tendermint.json,$PROJECT_ROOT/specs/mainnet-1/specs/ibc.json,$PROJECT_ROOT/specs/mainnet-1/specs/cosmossdk.json,$PROJECT_ROOT/specs/testnet-2/specs/lava.json"

IFS=',' read -r -a SPEC_FILES <<< "$SPECS_DIR"
for spec_file in "${SPEC_FILES[@]}"; do
	if [ ! -f "$spec_file" ]; then
		echo "âœ— ERROR: Spec file not found: $spec_file"
		exit 1
	fi
done

# Generate smart router config (3 upstream REST + 3 gRPC endpoints -> local node)
CONFIG_FILE="$PROJECT_ROOT/smartrouter_lava.yml"
echo ""
echo "Generating smart router config: $CONFIG_FILE"
echo "Upstream REST (LCD): $LAVA_REST_LOCAL"
echo "Upstream gRPC:       $LAVA_GRPC_LOCAL"
echo ""

# Clean up any old generated config in project root
rm -f "$CONFIG_FILE" 2>/dev/null || true

cat > "$CONFIG_FILE" <<EOF
# Smart Router Direct RPC Configuration (Lava local node)
# Mode: Direct connections to local lavad endpoints (no Lava providers!)
#
# This file is generated by: scripts/pre_setups/init_lava_smartrouter_lava.sh

endpoints:
  - network-address: "0.0.0.0:3360"
    chain-id: "LAV1"
    api-interface: "rest"

  - network-address: "0.0.0.0:3361"
    chain-id: "LAV1"
    api-interface: "grpc"

static-providers:
  # 3 upstream REST endpoints (all pointing at the same local node by default)
  # This matches the ETH direct-RPC scripts pattern and is useful for testing selection/failover logic.
  - name: "lava-local-rest-1"
    chain-id: "LAV1"
    api-interface: "rest"
    node-urls:
      - url: "$LAVA_REST_LOCAL"
        skip-verifications:
          - chain-id
          - pruning

  - name: "lava-local-rest-2"
    chain-id: "LAV1"
    api-interface: "rest"
    node-urls:
      - url: "$LAVA_REST_LOCAL"
        skip-verifications:
          - chain-id
          - pruning

  - name: "lava-local-rest-3"
    chain-id: "LAV1"
    api-interface: "rest"
    node-urls:
      - url: "$LAVA_REST_LOCAL"
        skip-verifications:
          - chain-id
          - pruning

  # 3 upstream gRPC endpoints (all pointing at the same local node by default)
  # grpc-config.allow-insecure: true is required for grpc:// (non-TLS) connections
  - name: "lava-local-grpc-1"
    chain-id: "LAV1"
    api-interface: "grpc"
    node-urls:
      - url: "$LAVA_GRPC_LOCAL"
        grpc-config:
          allow-insecure: true
        skip-verifications:
          - chain-id
          - pruning

  - name: "lava-local-grpc-2"
    chain-id: "LAV1"
    api-interface: "grpc"
    node-urls:
      - url: "$LAVA_GRPC_LOCAL"
        grpc-config:
          allow-insecure: true
        skip-verifications:
          - chain-id
          - pruning

  - name: "lava-local-grpc-3"
    chain-id: "LAV1"
    api-interface: "grpc"
    node-urls:
      - url: "$LAVA_GRPC_LOCAL"
        grpc-config:
          allow-insecure: true
        skip-verifications:
          - chain-id
          - pruning
EOF

# Verify config file was created
echo "Verifying generated config file..."
if [ -f "$CONFIG_FILE" ]; then
	FILE_SIZE=$(wc -c < "$CONFIG_FILE")
	echo "âœ“ Smart router config exists: $CONFIG_FILE (size: $FILE_SIZE bytes)"
else
	echo "âœ— ERROR: Smart router config NOT found: $CONFIG_FILE"
	exit 1
fi

echo ""
echo "[Test Setup] starting Smart Router (DIRECT RPC mode, REST + gRPC)"
screen -d -m -S smartrouter bash -c "cd \"$PROJECT_ROOT\" && source ~/.bashrc; lavap rpcsmartrouter \
smartrouter_lava.yml \
--geolocation 1 \
--log_level trace \
--cache-be \"127.0.0.1:20100\" \
--use-static-spec \"$SPECS_DIR\" \
--metrics-listen-address ':7779' 2>&1 | tee \"$LOGS_DIR/SMARTROUTER_LAVA.log\"" && sleep 0.25

sleep 3

echo "Verifying smart router screen session..."
if screen -list | grep -q "smartrouter"; then
	echo "âœ“ Smart router screen is running"
else
	echo "âœ— ERROR: Smart router screen failed to start!"
	echo "  Check $LOGS_DIR/SMARTROUTER_LAVA.log for errors"
	exit 1
fi

echo ""
echo "--- setting up screens done ---"
screen -ls

echo ""
echo "============================================"
echo "Smart Router (Lava local node) Setup Complete!"
echo "============================================"
echo "Local Lava REST:     $LAVA_REST_LOCAL"
echo "Local Lava gRPC:     $LAVA_GRPC_LOCAL"
echo "Cache:               127.0.0.1:20100 (metrics: 20200)"
echo "Smart Router REST:   http://127.0.0.1:3360 (metrics: 7779)"
echo "Smart Router gRPC:   127.0.0.1:3361"
echo ""
echo "ðŸ”¬ Test Commands (REST):"
echo "  # Health check (router process)"
echo "  curl -i http://127.0.0.1:3360/lava/health"
echo ""
echo "  # Query latest block via REST (proxied to local lavad LCD)"
echo "  curl http://127.0.0.1:3360/cosmos/base/tendermint/v1beta1/blocks/latest | head"
echo ""
echo "ðŸ”¬ Test Commands (gRPC):"
echo "  # List available gRPC services"
echo "  grpcurl -plaintext 127.0.0.1:3361 list"
echo ""
echo "  # Query node info via gRPC"
echo "  grpcurl -plaintext 127.0.0.1:3361 cosmos.base.tendermint.v1beta1.Service/GetNodeInfo"
echo ""
echo "  # Query latest block via gRPC"
echo "  grpcurl -plaintext 127.0.0.1:3361 cosmos.base.tendermint.v1beta1.Service/GetLatestBlock"
echo ""
echo "  # Query bank params via gRPC"
echo "  grpcurl -plaintext 127.0.0.1:3361 cosmos.bank.v1beta1.Query/Params"
echo ""
echo "ðŸ“Š Monitor Logs:"
echo "  tail -f $LOGS_DIR/SMARTROUTER_LAVA.log"
echo ""
echo "âœ‹ To Stop All Services:"
echo "  killall lavap lavad"
echo "  screen -wipe"
echo "============================================"

